<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מלאי בסניף</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #productInfo {
      margin-top: 20px;
    }
    #cartTable, #customerList {
      margin-top: 40px;
    }

    /* Modal styles */
    #newCustomerModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #newCustomerModal h3 {
      margin-top: 0;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    #priceSummary {
      margin-top: 20px;
    }

    /* Chat button styles */
    #openChatButton {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 2000;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>

<div class="container">
  <button onclick="logout()">התנתקות</button>
</div>

<!-- Chat Button -->
<button id="openChatButton">פתח צ'אט</button>

<h2>מלאי בסניף</h2>
<p id="branchName"></p>

<table id="inventoryTable">
  <thead>
  <tr>
    <th>#</th>
    <th>מין</th>
    <th>שם המוצר</th>
    <th>קטגוריה</th>
    <th>מידה</th>
    <th>כמות</th>
    <th>מחיר ליחידה</th>
    <th>הוסף לסל</th>
  </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<h2>סל הקניות</h2>
<table id="cartTable">
  <thead>
  <tr>
    <th>שם המוצר</th>
    <th>כמות</th>
    <th>מחיר</th>
  </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<h2>לקוחות</h2>
<select id="customerList" onchange="updatePriceSummary()">
  <option value="">בחר לקוח</option>
</select>
<button id="addNewCustomer">הוסף לקוח חדש</button>

<div id="priceSummary">
  <p>סה"כ לפני הנחה: ₪<span id="totalPrice">0.00</span></p>
  <p>הנחה: ₪<span id="discountAmount">0.00"></span></p>
  <p>סה"כ לאחר הנחה: ₪<span id="finalPrice">0.00"></span></p>
</div>

<button id="purchaseButton">בצע רכישה</button>

<!-- Modal to add new customer -->
<div id="newCustomerModal">
  <h3>הוסף לקוח חדש</h3>
  <label>שם:</label>
  <input type="text" id="newCustomerName" placeholder="הכנס שם"><br>
  <label>דואר אלקטרוני:</label>
  <input type="email" id="newCustomerEmail" placeholder="הכנס דואר אלקטרוני"><br>
  <label>מספר דרכון:</label>
  <input type="text" id="newCustomerPassport" placeholder="הכנס מספר דרכון"><br>
  <label>מספר טלפון:</label>
  <input type="text" id="newCustomerPhone" placeholder="הכנס מספר טלפון"><br>
  <label>סוג לקוח:</label>
  <select id="customerType">
    <option value="NewCustomer">חדש</option>
    <option value="CircularCustomer">מעגלי</option>
    <option value="VipCustomer">VIP</option>
  </select>
  <br>
  <button id="saveCustomer">שמור</button>
  <button id="closeModal">סגור</button>
</div>
<div class="modal-overlay"></div>

<script>
  let cart = [];

  // Store userId globally
  let userId = getQueryParam('userId');

  // Function to get query parameters from the URL
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // Function to logout the user
  function logout() {
    if (!userId) {
      alert('User ID is missing. Please try again.');
      return;
    }

    fetch(`/admin/users/isoffline?userId=${userId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (response.ok) {
        alert('התנתקת בהצלחה.');
        // Redirect to the login page after successful logout
        window.location.href = '/login';
      } else {
        alert('ההתנתקות נכשלה. אנא נסה שוב.');
      }
    }).catch(error => {
      console.error('Error:', error);
      alert('ההתנתקות נכשלה. אנא נסה שוב.');
    });
  }

  // Fetch the branchId from the URL
  const branchId = getQueryParam('branchId');

  if (!branchId || !userId) {
    alert("No branchId or userId found. Please log in again.");
    window.location.href = '/login'; // Redirect to login if no branchId or userId
  } else {
    // Mark user as online
    function markUserAsOnline() {
      fetch(`/admin/users/isonline?userId=${userId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
              .then(response => {
                if (response.ok) {
                  console.log('User marked as online.');
                } else {
                  console.error('Failed to mark user as online.');
                }
              })
              .catch(error => {
                console.error('Error:', error);
              });
    }

    // Automatically mark user as online when the page loads
    window.onload = function() {
      markUserAsOnline();

      // Fetch product list for the employee's branch
      fetch(`http://localhost:8080/api/products/branch/${branchId}`)
              .then(response => response.json())
              .then(data => {
                const tableBody = document.querySelector('#inventoryTable tbody');
                const branchNameElement = document.getElementById('branchName');

                if (data.length > 0) {
                  branchNameElement.textContent = `שם הסניף: ${data[0].branch.name}, מיקום: ${data[0].branch.location}`;
                }

                data.forEach((product, index) => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
            <td>${index + 1}</td>
            <td>${product.type}</td>
            <td>${product.name}</td>
            <td>${product.category}</td>
            <td>${product.size}</td>
            <td>${product.quantity}</td>
            <td>₪${product.price.toFixed(2)}</td>
            <td><button onclick="addToCart(${index + 1}, '${product.name}', ${product.price})">+</button></td>
          `;
                  tableBody.appendChild(row);
                });
              })
              .catch(error => console.error('Error fetching products:', error));

      // Fetch the customer list
      fetch('http://localhost:8080/admin/customers')
              .then(response => response.json())
              .then(customers => {
                const customerList = document.getElementById('customerList');
                customers.forEach(customer => {
                  const option = document.createElement('option');
                  option.value = customer.id;
                  option.textContent = customer.name;
                  customerList.appendChild(option);
                });
              })
              .catch(error => console.error('Error fetching customers:', error));
    }
  }

  // Function to add product to cart
  function addToCart(productId, productName, productPrice) {
    const cartTableBody = document.querySelector('#cartTable tbody');
    const cartItem = {
      id: productId,
      name: productName,
      price: productPrice,
      quantity: 1
    };

    cart.push(cartItem);
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${productName}</td>
      <td>1</td>
      <td>₪${productPrice.toFixed(2)}</td>
    `;
    cartTableBody.appendChild(row);

    // Update the total price
    updatePriceSummary();
  }

  // Function to calculate the total price and discount
  function updatePriceSummary() {
    const totalPriceElement = document.getElementById('totalPrice');
    const discountAmountElement = document.getElementById('discountAmount');
    const finalPriceElement = document.getElementById('finalPrice');
    const selectedCustomer = document.getElementById('customerList').value;

    if (!selectedCustomer) {
      return; // No customer selected, skip the price calculation
    }

    // Fetch customer details to get their type
    fetch(`http://localhost:8080/admin/customers/${selectedCustomer}`)
            .then(response => response.json())
            .then(customer => {
              let discount = 0;

              // Determine discount based on customer type
              if (customer.type === 'circular') {
                discount = 0.05; // 5% discount
              } else if (customer.type === 'Vip') {
                discount = 0.15; // 15% discount
              }

              // Calculate total price
              let totalPrice = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
              let discountAmount = totalPrice * discount;
              let finalPrice = totalPrice - discountAmount;

              // Update the DOM with price summary
              totalPriceElement.textContent = totalPrice.toFixed(2);
              discountAmountElement.textContent = discountAmount.toFixed(2);
              finalPriceElement.textContent = finalPrice.toFixed(2);
            })
            .catch(error => console.error('Error fetching customer for discount:', error));
  }

  // Show modal to add new customer
  document.getElementById('addNewCustomer').addEventListener('click', () => {
    document.querySelector('.modal-overlay').style.display = 'block';
    document.getElementById('newCustomerModal').style.display = 'block';
  });

  // Close modal
  document.getElementById('closeModal').addEventListener('click', () => {
    document.querySelector('.modal-overlay').style.display = 'none';
    document.getElementById('newCustomerModal').style.display = 'none';
  });

  // Save new customer
  document.getElementById('saveCustomer').addEventListener('click', () => {
    const name = document.getElementById('newCustomerName').value;
    const email = document.getElementById('newCustomerEmail').value;
    const passport = document.getElementById('newCustomerPassport').value;
    const phone = document.getElementById('newCustomerPhone').value;
    const type = document.getElementById('customerType').value; // Get customer type from dropdown

    fetch('http://localhost:8080/admin/customers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        passport: passport,
        phone: phone,
        type: type,
        name: name,
        email: email
      })
    })
            .then(response => response.json())
            .then(customer => {
              const customerList = document.getElementById('customerList');
              const option = document.createElement('option');
              option.value = customer.id;
              option.textContent = customer.name;
              customerList.appendChild(option);
              document.querySelector('.modal-overlay').style.display = 'none'; // Hide modal
              document.getElementById('newCustomerModal').style.display = 'none';
            })
            .catch(error => console.error('Error adding customer:', error));
  });

  // Handle purchase execution
  document.getElementById('purchaseButton').addEventListener('click', () => {
    const selectedCustomer = document.getElementById('customerList').value;

    if (!selectedCustomer) {
      alert('אנא בחר לקוח לפני ביצוע רכישה.');
      return;
    }

    // Validate the cart is not empty
    if (cart.length === 0) {
      alert('סל הקניות ריק. אנא הוסף מוצרים לפני ביצוע רכישה.');
      return;
    }

    // Function to process each item in the cart
    cart.forEach(item => {
      // Send a separate request for each item in the cart
      fetch(`http://localhost:8080/admin/sales/sell?employeeId=${userId}&productId=${item.id}&branchId=${branchId}&quantity=${item.quantity}&customerId=${selectedCustomer}`, {
        method: 'POST'
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Error: ${response.status} ${response.statusText}`);
                }
                return response.json();
              })
              .then(result => {
                console.log(`Purchase successful for product: ${item.name}`);
              })
              .catch(error => {
                console.error('Purchase failed:', error);
                alert('שגיאה במהלך הרכישה: ' + error.message);
              });
    });

    // Clear the cart and update the UI after processing all items
    cart = [];
    document.querySelector('#cartTable tbody').innerHTML = '';
    updatePriceSummary();
    alert('רכישה בוצעה בהצלחה!');
  });

  // Handle chat button click
  document.getElementById('openChatButton').addEventListener('click', function () {
    window.open('http://localhost:8080/chat-test.html', '_blank', 'width=400,height=700');
  });

</script>

</body>
</html>
