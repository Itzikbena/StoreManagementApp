<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מלאי בסניף</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #productInfo {
      margin-top: 20px;
    }
    #cartTable, #customerList {
      margin-top: 40px;
    }
    /* Modal styles */
    #newCustomerModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #newCustomerModal h3 {
      margin-top: 0;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    #priceSummary {
      margin-top: 20px;
    }

    /* Chat styles */
    #chat-container {
      position: fixed;
      bottom: 0;
      right: 20px;
      width: 300px;
      height: 400px;
      display: none; /* Initially hidden */
      border: 1px solid #ccc;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    #chat-header {
      background-color: #007bff;
      color: white;
      padding: 10px;
      text-align: center;
      cursor: pointer;
    }

    #chat-content {
      height: 300px;
      overflow-y: auto;
      padding: 10px;
    }

    #chat-input-container {
      display: flex;
      padding: 10px;
    }

    #chat-input {
      flex-grow: 1;
      padding: 5px;
    }

    #send-button {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    #open-chat-button {
      position: fixed;
      bottom: 10px;
      right: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    /* Styles for the user list */
    #user-list-container {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 10px;
      width: 300px;
      background-color: #f9f9f9;
      position: fixed;
      right: 20px;
      top: 10%;
    }

    #user-list {
      list-style-type: none;
      padding: 0;
    }

    #user-list li {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }

    #user-list li:hover {
      background-color: #f2f2f2;
    }

  </style>
</head>
<body>

<h2>מלאי בסניף</h2>
<p id="branchName"></p>

<table id="inventoryTable">
  <thead>
  <tr>
    <th>Index</th>
    <th>מין</th>
    <th>שם המוצר</th>
    <th>קטגוריה</th>
    <th>מידה</th>
    <th>כמות</th>
    <th>מחיר ליחידה</th>
    <th>הוסף לסל</th>
  </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<h2>סל הקניות</h2>
<table id="cartTable">
  <thead>
  <tr>
    <th>שם המוצר</th>
    <th>כמות</th>
    <th>מחיר</th>
  </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<h2>לקוחות</h2>
<select id="customerList" onchange="updatePriceSummary()"> <!-- Call updatePriceSummary when customer is selected -->
  <option value="">בחר לקוח</option>
</select>
<button id="addNewCustomer">הוסף לקוח חדש</button>

<div id="priceSummary">
  <p>סה"כ לפני הנחה: ₪<span id="totalPrice">0.00</span></p>
  <p>הנחה: ₪<span id="discountAmount">0.00</span></p>
  <p>סה"כ לאחר הנחה: ₪<span id="finalPrice">0.00</span></p>
</div>

<button id="purchaseButton">בצע רכישה</button>

<!-- Chat button to open the chat window -->
<button id="open-chat-button">Open Chat</button>

<!-- Chat container (initially hidden) -->
<div id="chat-container">
  <div id="chat-header">Chat Support</div>
  <div id="chat-content">
    <p>Welcome to the chat!</p>
  </div>
  <div id="chat-input-container">
    <input type="text" id="chat-input" placeholder="Type your message here...">
    <button id="send-button">Send</button>
  </div>
</div>

<!-- User list container -->
<div id="user-list-container">
  <h4>Available Users</h4>
  <ul id="user-list"></ul>
</div>

<!-- Modal to add new customer -->
<div id="newCustomerModal">
  <h3>הוסף לקוח חדש</h3>
  <label>שם:</label>
  <input type="text" id="newCustomerName" placeholder="הכנס שם"><br>
  <label>דואר אלקטרוני:</label>
  <input type="email" id="newCustomerEmail" placeholder="הכנס דואר אלקטרוני"><br>
  <label>מספר דרכון:</label>
  <input type="text" id="newCustomerPassport" placeholder="הכנס מספר דרכון"><br>
  <label>מספר טלפון:</label>
  <input type="text" id="newCustomerPhone" placeholder="הכנס מספר טלפון"><br>
  <button id="saveCustomer">שמור</button>
  <button id="closeModal">סגור</button>
</div>
<div class="modal-overlay"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
  let cart = [];
  let currentChatUser = null;

  // Function to get query parameters from the URL
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  const branchId = getQueryParam('branchId');
  const userId = getQueryParam('userId');  // Assume this is the logged-in user's ID

  if (!branchId || !userId) {
    alert("No branchId or userId found. Please log in again.");
    window.location.href = '/login';
  } else {
    // Fetch products for the branch
    fetch(`http://localhost:8080/api/products/branch/${branchId}`)
            .then(response => response.json())
            .then(data => {
              const tableBody = document.querySelector('#inventoryTable tbody');
              const branchNameElement = document.getElementById('branchName');

              if (data.length > 0) {
                branchNameElement.textContent = `שם הסניף: ${data[0].branch.name}, מיקום: ${data[0].branch.location}`;
              }

              data.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${index + 1}</td>
            <td>${product.type}</td>
            <td>${product.name}</td>
            <td>${product.category}</td>
            <td>${product.size}</td>
            <td>${product.quantity}</td>
            <td>₪${product.price.toFixed(2)}</td>
            <td><button onclick="addToCart(${index + 1}, '${product.name}', ${product.price})">+</button></td>
          `;
                tableBody.appendChild(row);
              });
            })
            .catch(error => console.error('Error fetching products:', error));

    // Fetch customer list
    fetch('http://localhost:8080/admin/customers')
            .then(response => response.json())
            .then(customers => {
              const customerList = document.getElementById('customerList');
              customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                customerList.appendChild(option);
              });
            })
            .catch(error => console.error('Error fetching customers:', error));

    // Fetch user list for chat
    fetch('http://localhost:8080/admin/users/list')
            .then(response => response.json())
            .then(users => {
              const userList = document.getElementById('user-list');
              users.forEach(user => {
                const listItem = document.createElement('li');
                listItem.textContent = `${user.name || 'Unknown'} (${user.online ? 'Online' : 'Offline'})`;
                listItem.onclick = () => startChat(user);
                userList.appendChild(listItem);
              });
            })
            .catch(error => console.error('Error fetching users:', error));
  }

  function startChat(user) {
    currentChatUser = user;
    document.getElementById('chat-content').innerHTML = `Chatting with ${user.name}`;
  }

  const chatButton = document.getElementById('open-chat-button');
  const chatContainer = document.getElementById('chat-container');
  const chatHeader = document.getElementById('chat-header');

  chatButton.addEventListener('click', function() {
    chatContainer.style.display = chatContainer.style.display === 'block' ? 'none' : 'block';
  });

  chatHeader.addEventListener('click', function() {
    chatContainer.style.display = 'none';
  });

  const sendMessageButton = document.getElementById('send-button');
  sendMessageButton.addEventListener('click', function () {
    const messageContent = document.getElementById('chat-input').value.trim();

    if (messageContent && currentChatUser && currentChatUser.id) {  // Ensure currentChatUser is set and has an id
      const messagePayload = {
        content: messageContent,
        sender: userId,  // Sending userId from current user
        userId: currentChatUser.id  // Send message to selected chat user by userId
      };

      // Display the message in the chat immediately
      showMessage(`You: ${messageContent}`);

      // Send the message to the server
      fetch(`/chat/sendToUser`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(messagePayload),
      })
              .then(response => {
                if (response.ok) {
                  // Clear the input field after successful send
                  document.getElementById('chat-input').value = '';
                } else {
                  alert('Failed to send message. Please try again.');
                }
              })
              .catch(error => {
                alert('Error sending message.');
              });
    } else {
      alert('Message content or User ID is missing.');
    }
  });

  // Establish WebSocket connection
  var socket = new SockJS('/chat-websocket');
  var stompClient = Stomp.over(socket);

  stompClient.connect({}, function (frame) {
    console.log('Connected: ' + frame);

    // Subscribe to private messages for this user
    stompClient.subscribe(`/user/${userId}/queue/messages`, function (messageOutput) {
      const message = JSON.parse(messageOutput.body);
      showMessage(`${message.sender}: ${message.content}`);  // Display the received message
    });
  });

  function showMessage(message) {
    var chatContent = document.getElementById('chat-content');
    var newMessage = document.createElement('p');
    newMessage.textContent = message;
    chatContent.appendChild(newMessage);
  }
</script>

</body>
</html>
