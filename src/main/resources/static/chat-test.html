<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Test</title>
  <style>
    #chatIcon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: #007bff;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    #chatWindow {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 90%; /* Adjust width to fit better on different screen sizes */
      max-width: 400px; /* Maximum width to avoid being too large */
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      display: none;
      z-index: 999;
      max-height: 70%; /* Constrain the height so it won't exceed the browser height */
      overflow-y: auto; /* Allow scrolling if the content exceeds the window height */
    }

    #onlineUsers {
      height: 200px; /* Adjust height */
      max-height: 40%; /* Make the user list responsive */
      overflow-y: auto;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.5);
    }

    #messages {
      height: 200px;
      max-height: 40%; /* Make the messages section responsive */
      overflow-y: auto;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.5);
    }

    #messageInput {
      width: 80%;
    }

    #chatArea {
      padding: 10px;
    }

    .onlineUser {
      cursor: pointer;
      color: blue;
    }

    /* Private chat window styles */
    .privateChatWindow {
      position: fixed;
      bottom: 0px;
      width: 300px;
      height: 300px;
      border: 1px solid #ccc;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      overflow: hidden;
    }

    .privateChatHeader {
      background-color: #007bff;
      color: white;
      padding: 5px;
      text-align: center;
      cursor: move;
    }

    .privateChatMessages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    .privateChatInput {
      display: flex;
      border-top: 1px solid #ccc;
    }

    .privateChatInput input {
      flex: 1;
      padding: 5px;
      border: none;
      outline: none;
    }

    .privateChatInput button {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    .privateChatClose {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- Chat Icon (Facebook-like) -->
<div id="chatIcon" onclick="toggleChatWindow()">ðŸ’¬</div>

<!-- Main chat window -->
<div id="chatWindow">
  <h3>Online Users</h3>
  <!-- This is where the active users list will be shown -->
  <div id="onlineUsers"></div>

  <div id="chatArea">
    <h4>Public Chat</h4>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a public message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Include SockJS and Stomp.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
  let stompClient = null;
  let username = null;
  let openChatWindows = [];
  let messageHistory = {}; // Object to store message history for each user

  // Toggle chat window visibility
  function toggleChatWindow() {
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
  }

  // Connect to WebSocket as soon as the page loads
  window.onload = function () {
    connectToChat();
    loadAllMessageHistory(); // Load message history from localStorage on page load
  };

  // Connect to WebSocket and subscribe to channels
  function connectToChat() {
    const socket = new SockJS('/chat-websocket');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      // Fetch the username from the session (set by backend)
      fetch('/api/getUsername')
              .then(response => response.json())
              .then(data => {
                username = data.username;

                // Subscribe to public messages
                stompClient.subscribe('/topic/messages', function (message) {
                  showMessage(JSON.parse(message.body));
                });

                // Subscribe to private messages sent to this user
                stompClient.subscribe('/user/queue/messages', function (message) {
                  showPrivateMessage(JSON.parse(message.body));
                });

                // Subscribe to active users and update the list
                stompClient.subscribe('/topic/activeUsers', function (message) {
                  updateActiveUsers(JSON.parse(message.body));
                });

                // Notify the server that the user has logged in
                stompClient.send("/app/userLogin", {}, JSON.stringify({'username': username}));
              });
    });
  }

  // Send public message
  function sendMessage() {
    const messageContent = document.getElementById('messageInput').value;
    if (messageContent && stompClient) {
      stompClient.send("/app/sendToUser", {}, JSON.stringify({
        'username': username,
        'message': messageContent
      }));
      document.getElementById('messageInput').value = ''; // Clear input
    }
  }

  // Display public message
  function showMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.innerText = message.username + ": " + message.message;
    document.getElementById('messages').appendChild(messageElement);
  }

  // Display private message and save it in the history
  function showPrivateMessage(message) {
    if (!messageHistory[message.username]) {
      messageHistory[message.username] = []; // Initialize history if it doesn't exist
    }
    messageHistory[message.username].push(message); // Save message to history
    saveMessageHistory(message.username); // Save to localStorage
    openPrivateChat(message.username); // Open chat window
    const chatWindow = document.getElementById('privateChat_' + message.username);
    const chatMessages = chatWindow.querySelector('.privateChatMessages');
    const messageElement = document.createElement('div');
    messageElement.innerText = message.username + ": " + message.message;
    chatMessages.appendChild(messageElement);
  }

  // Update the UI with the active users
  function updateActiveUsers(users) {
    const onlineUsersDiv = document.getElementById('onlineUsers');
    onlineUsersDiv.innerHTML = ''; // Clear the list

    users.forEach(user => {
      const userElement = document.createElement('div');
      userElement.classList.add('onlineUser');
      userElement.innerText = user;  // Display username
      userElement.onclick = function() {
        openPrivateChat(user);  // Pass the username for private chat
      };
      onlineUsersDiv.appendChild(userElement);
    });
  }

  // Open private chat with selected user
  function openPrivateChat(recipient) {
    // Check if the chat window already exists
    if (document.getElementById('privateChat_' + recipient)) {
      return;
    }

    const privateChatWindow = document.createElement('div');
    privateChatWindow.id = 'privateChat_' + recipient;
    privateChatWindow.classList.add('privateChatWindow');
    privateChatWindow.innerHTML = `
      <div class="privateChatHeader">
        Chat with ${recipient}
        <span class="privateChatClose" onclick="closePrivateChat('${recipient}')">&times;</span>
      </div>
      <div class="privateChatMessages"></div>
      <div class="privateChatInput">
        <input type="text" placeholder="Type a message" id="privateMessageInput_${recipient}">
        <button onclick="sendPrivateMessage('${recipient}')">Send</button>
      </div>
    `;

    // Positioning logic
    const positionIndex = openChatWindows.length; // Get the number of open chat windows
    const baseRight = positionIndex === 0 ? 440 : 300; // First chat window will be 50px (5cm) more to the left
    privateChatWindow.style.right = (baseRight + positionIndex * 320) + 'px'; // Adjust '320' based on chat window width and spacing
    privateChatWindow.style.bottom = '0px';

    document.body.appendChild(privateChatWindow);
    openChatWindows.push(recipient); // Add to the list of open chat windows

    // Load message history if available
    loadMessageHistory(recipient);
  }

  // Send private message to selected user
  function sendPrivateMessage(recipient) {
    const input = document.getElementById('privateMessageInput_' + recipient);
    const messageContent = input.value;
    if (messageContent && stompClient) {
      const message = {
        'username': username,
        'message': messageContent,
        'recipient': recipient
      };
      stompClient.send("/app/sendPrivateMessage", {}, JSON.stringify(message));
      input.value = ''; // Clear input

      // Add message to chat window and save in history
      const chatMessages = document.getElementById('privateChat_' + recipient).querySelector('.privateChatMessages');
      const messageElement = document.createElement('div');
      messageElement.innerText = "Me: " + messageContent;
      chatMessages.appendChild(messageElement);

      // Save message in history
      if (!messageHistory[recipient]) {
        messageHistory[recipient] = [];
      }
      messageHistory[recipient].push(message);
      saveMessageHistory(recipient); // Save to localStorage
    }
  }

  // Close private chat window
  function closePrivateChat(recipient) {
    const privateChatWindow = document.getElementById('privateChat_' + recipient);
    if (privateChatWindow) {
      document.body.removeChild(privateChatWindow);
      openChatWindows = openChatWindows.filter(user => user !== recipient); // Remove from the list of open chat windows
      rearrangeChatWindows(); // Rearrange remaining chat windows
    }
  }

  // Rearrange remaining chat windows after one is closed
  function rearrangeChatWindows() {
    openChatWindows.forEach((user, index) => {
      const chatWindow = document.getElementById('privateChat_' + user);
      const baseRight = index === 0 ? 70 : 20; // Adjust first window to the left
      chatWindow.style.right = (baseRight + index * 320) + 'px'; // Adjust '320' based on chat window width and spacing
    });
  }

  // Load message history for a recipient
  function loadMessageHistory(recipient) {
    if (messageHistory[recipient]) {
      const chatWindow = document.getElementById('privateChat_' + recipient);
      const chatMessages = chatWindow.querySelector('.privateChatMessages');
      messageHistory[recipient].forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.innerText = message.username + ": " + message.message;
        chatMessages.appendChild(messageElement);
      });
    }
  }

  // Save message history to localStorage
  function saveMessageHistory(recipient) {
    localStorage.setItem('messageHistory_' + recipient, JSON.stringify(messageHistory[recipient]));
  }

  // Load all message history from localStorage
  function loadAllMessageHistory() {
    for (let key in localStorage) {
      if (key.startsWith('messageHistory_')) {
        const recipient = key.replace('messageHistory_', '');
        messageHistory[recipient] = JSON.parse(localStorage.getItem(key));
      }
    }
  }
</script>

</body>
</html>
