<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Test</title>
  <style>
    #chatIcon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: #007bff;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    #chatWindow {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 90%; /* Adjust width to fit better on different screen sizes */
      max-width: 400px; /* Maximum width to avoid being too large */
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      display: none;
      z-index: 999;
      max-height: 70%; /* Constrain the height so it won't exceed the browser height */
      overflow-y: auto; /* Allow scrolling if the content exceeds the window height */
    }

    #onlineUsers {
      height: 200px; /* Adjust height */
      max-height: 40%; /* Make the user list responsive */
      overflow-y: auto;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.5);
    }

    #messages {
      height: 200px;
      max-height: 40%; /* Make the messages section responsive */
      overflow-y: auto;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.5);
    }


    #messageInput {
      width: 80%;
    }

    #chatArea {
      padding: 10px;
    }

    .onlineUser {
      cursor: pointer;
      color: blue;
    }
  </style>
</head>
<body>

<!-- Chat Icon (Facebook-like) -->
<div id="chatIcon" onclick="toggleChatWindow()">ðŸ’¬</div>

<!-- Main chat window -->
<div id="chatWindow">
  <h3>Online Users</h3>
  <!-- This is where the active users list will be shown -->
  <div id="onlineUsers" style="height: 400px; overflow-y: auto; padding: 10px; background-color: rgba(255, 255, 255, 0.5);"></div>

  <div id="chatArea">
    <h4>Public Chat</h4>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a public message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>


<!-- Include SockJS and Stomp.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
  let stompClient = null;
  let username = null;

  // Toggle chat window visibility
  function toggleChatWindow() {
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
    console.log("Chat window toggled. Current display status:", chatWindow.style.display);
  }

  // Connect to WebSocket as soon as the page loads
  window.onload = function () {
    console.log("Page loaded, connecting to WebSocket...");
    connectToChat();
  };

  // Connect to WebSocket and subscribe to channels
  function connectToChat() {
    console.log("Attempting WebSocket connection...");
    const socket = new SockJS('/chat-websocket');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      console.log('Connected to WebSocket: ' + frame);

      // Fetch the username from the session (set by backend)
      fetch('/api/getUsername')
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to fetch username');
                }
                return response.json();
              })
              .then(data => {
                username = data.username;
                console.log("Logged in as: " + username);

                // Subscribe to public messages
                stompClient.subscribe('/topic/messages', function (message) {
                  console.log("Received public message:", message.body);
                  showMessage(JSON.parse(message.body));
                });

                // Subscribe to private messages sent to this user
                stompClient.subscribe('/user/queue/messages', function (message) {
                  console.log("Received private message:", message.body);
                  showPrivateMessage(JSON.parse(message.body));
                });

                // Subscribe to active users and update the list
                stompClient.subscribe('/topic/activeUsers', function (message) {
                  const users = JSON.parse(message.body);
                  console.log("Received active users list:", users);  // Debugging log to verify the message
                  updateActiveUsers(users);
                });

                // Notify the server that the user has logged in
                stompClient.send("/app/userLogin", {}, JSON.stringify({'username': username}));
              })
              .catch(error => {
                console.error('Error fetching username or during WebSocket connection:', error);
              });
    }, function (error) {
      console.error('WebSocket connection failed:', error);
    });
  }

  // Send public message
  function sendMessage() {
    const messageContent = document.getElementById('messageInput').value;
    console.log("Attempting to send message:", messageContent);

    if (messageContent && stompClient) {
      stompClient.send("/app/sendToUser", {}, JSON.stringify({
        'username': username,
        'message': messageContent
      }));
      console.log("Message sent:", messageContent);
      document.getElementById('messageInput').value = ''; // Clear input
    } else {
      console.warn("Message sending failed: No content or WebSocket connection not established.");
    }
  }

  // Display public message
  function showMessage(message) {
    console.log("Displaying public message:", message);
    const messageElement = document.createElement('div');
    messageElement.innerText = message.username + ": " + message.message;
    document.getElementById('messages').appendChild(messageElement);
  }

  // Display private message
  function showPrivateMessage(message) {
    console.log("Displaying private message:", message);
    const messageElement = document.createElement('div');
    messageElement.innerHTML = "<strong>Private:</strong> " + message.username + ": " + message.message;
    document.getElementById('messages').appendChild(messageElement);
  }

  // Update the UI with the active users
  function updateActiveUsers(users) {
    const onlineUsersDiv = document.getElementById('onlineUsers');
    onlineUsersDiv.innerHTML = ''; // Clear the list

    users.forEach(user => {
      const userElement = document.createElement('div');
      userElement.classList.add('onlineUser');
      userElement.innerText = user;  // Display username
      userElement.onclick = function() {
        openPrivateChat(user);  // Pass the username for private chat
      };
      onlineUsersDiv.appendChild(userElement);
    });

    console.log("Active users updated:", users); // Debugging log
  }


  // Open private chat with selected user
  function openPrivateChat(recipient) {
    console.log("Opening private chat with:", recipient);
    const privateMessageContent = prompt("Type your message to " + recipient);
    if (privateMessageContent && stompClient) {
      stompClient.send("/app/sendPrivateMessage", {}, JSON.stringify({
        'username': username,
        'message': privateMessageContent,
        'recipient': recipient
      }));
      console.log("Private message sent to", recipient);
    } else {
      console.warn("Private message sending failed: No content or WebSocket connection not established.");
    }
  }
</script>

</body>
</html>
