<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Test</title>
  <style>
    #chatIcon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: #007bff;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    #chatWindow {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 300px;
      background-color: white;
      border: 1px solid #ccc;
      display: none;
    }

    #onlineUsers {
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #fafafa; /* Temporary for visibility */
    }


    #messages {
      height: 200px;
      overflow-y: auto;
      padding: 10px;
    }

    #messageInput, #privateMessageInput {
      width: 80%;
    }

    #chatArea {
      padding: 10px;
    }

    .privateChatWindow {
      position: fixed;
      bottom: 80px;
      right: 340px; /* adjust based on how many chat windows you want to open */
      width: 300px;
      background-color: white;
      border: 1px solid #ccc;
      display: none;
    }

    .onlineUser {
      cursor: pointer;
      color: blue;
    }
  </style>
</head>
<body>

<!-- Small chat icon (Facebook-like) -->
<div id="chatIcon" onclick="toggleChatWindow()">ðŸ’¬</div>

<!-- Main chat window -->
<div id="chatWindow">
  <h3>Online Users</h3>
  <div id="onlineUsers"></div>
  <div id="chatArea">
    <h4>Public Chat</h4>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a public message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Include SockJS and Stomp.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
  let stompClient = null;
  let username = null; // Username will be set based on the authentication session

  // Toggle chat window visibility
  function toggleChatWindow() {
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
  }

  // Connect to WebSocket as soon as the page loads
  window.onload = function () {
    connectToChat();
  };

  // Connect to WebSocket and subscribe to public and private message channels
  function connectToChat() {
    const socket = new SockJS('/chat-websocket'); // WebSocket endpoint
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);

      // Fetch the username from the session (set by backend)
      fetch('/api/getUsername')
              .then(response => response.json())
              .then(data => {
                username = data.username;  // Store the username from session
                console.log("Logged in as: " + username);

                // Subscribe to public messages
                stompClient.subscribe('/topic/messages', function (message) {
                  showMessage(JSON.parse(message.body));
                });

                // Subscribe to private messages sent to this user
                stompClient.subscribe('/user/queue/messages', function (message) {
                  showPrivateMessage(JSON.parse(message.body));
                });

                stompClient.subscribe('/topic/activeUsers', function (message) {
                  const users = JSON.parse(message.body);
                  console.log("Received active users:", users); // Debugging log
                  updateActiveUsers(users);
                });


                // Notify the server that the user has logged in
                stompClient.send("/app/userLogin", {}, JSON.stringify({'username': username}));
              });
    });
  }

  // Send public message
  function sendMessage() {
    const messageContent = document.getElementById('messageInput').value;
    if (messageContent && stompClient) {
      stompClient.send("/app/sendToUser", {}, JSON.stringify({
        'username': username,  // Sender's username
        'message': messageContent
      }));
      document.getElementById('messageInput').value = ''; // Clear input
    }
  }

  // Send private message
  function sendPrivateMessage(recipient) {
    const privateMessageContent = prompt("Type your message to " + recipient);
    if (privateMessageContent && stompClient) {
      stompClient.send("/app/sendPrivateMessage", {}, JSON.stringify({
        'username': username,  // Sender's username
        'message': privateMessageContent,
        'recipient': recipient  // Use the correct recipient's username, not an index
      }));
    }
  }


  // Display public message
  function showMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.innerText = message.username + ": " + message.message;
    document.getElementById('messages').appendChild(messageElement);
  }

  // Display private message
  function showPrivateMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.innerHTML = "<strong>Private:</strong> " + message.username + ": " + message.message;
    document.getElementById('messages').appendChild(messageElement);
  }

  // Update the list of active users for private messaging
  function updateActiveUsers(users) {
    const onlineUsersDiv = document.getElementById('onlineUsers');
    onlineUsersDiv.innerHTML = ''; // Clear the list

    users.forEach(user => {  // Ensure we iterate over the actual usernames
      const userElement = document.createElement('div');
      userElement.classList.add('onlineUser');
      userElement.innerText = user;  // Use the actual username
      userElement.onclick = function() {
        openPrivateChat(user);  // Pass the correct username for private chat
      };
      onlineUsersDiv.appendChild(userElement);
    });

    console.log("Active users updated:", users); // Debugging log
  }





  // Open a private chat window with the selected user
  function openPrivateChat(recipient) {
    // Prompt for private message
    sendPrivateMessage(recipient);
  }
</script>

</body>
</html>
